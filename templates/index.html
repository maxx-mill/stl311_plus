<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STL 311 Service Requests Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header .navigation-buttons {
            position: absolute;
            top: 15px;
            right: 15px;
        }
        
        .header .navigation-buttons .btn {
            margin-left: 5px;
        }
        
        @media (max-width: 768px) {
            .header .navigation-buttons {
                position: static;
                margin-top: 15px;
            }
        }
        
        #map {
            height: 80vh;
            width: 100%;
        }
        
        .stats {
            padding: 15px;
            background: #f8f9fa;
            text-align: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 200px;
        }
        
        .legend h6 {
            margin: 0 0 12px 0;
            font-weight: bold;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .legend-text {
            font-size: 14px;
            color: #333;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 76px);
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #dee2e6;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        .filter-section {
            margin-bottom: 25px;
        }
        
        .filter-section h6 {
            color: #495057;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .stats-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }
        
        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="navigation-buttons">
            <a href="/submit" class="btn btn-success btn-sm">
                <i class="bi bi-plus-circle"></i> Submit Request
            </a>
            <a href="/track" class="btn btn-outline-light btn-sm">
                <i class="bi bi-search"></i> Track Request
            </a>
            <a href="/" class="btn btn-outline-light btn-sm active">
                <i class="bi bi-map"></i> View Map
            </a>
        </div>
        <h1><i class="bi bi-geo-alt-fill"></i> STL 311 Service Requests</h1>
        <p class="mb-0 opacity-75">Interactive Map of St. Louis Service Requests</p>
    </div>
    
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters & Stats</h5>
            </div>
            
            <div class="sidebar-content">
                <!-- Stats Cards -->
                <div class="stats-card">
                    <div class="stats-value" id="total-count">0</div>
                    <div class="stats-label">Total Requests</div>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-value" id="new-count" style="color: #27ae60;">0</div>
                            <div class="stats-label">New</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-value" id="closed-count" style="color: #e74c3c;">0</div>
                            <div class="stats-label">Closed</div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Filter -->
                <div class="filter-section">
                    <h6><i class="bi bi-funnel"></i> Filter by Status</h6>
                    <select class="form-select" id="status-filter">
                        <option value="">All Statuses</option>
                        <option value="New">New</option>
                        <option value="Inspect">In Progress</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                
                <!-- Problem Type Filter -->
                <div class="filter-section">
                    <h6><i class="bi bi-tools"></i> Filter by Problem Type</h6>
                    <select class="form-select" id="problem-type-filter">
                        <option value="">All Problem Types</option>
                        <option value="refuse">Trash & Refuse</option>
                        <option value="traffic">Traffic & Street Lights</option>
                        <option value="street">Street & Infrastructure</option>
                        <option value="vehicle">Abandoned Vehicles</option>
                        <option value="building">Building Issues</option>
                        <option value="forestry">Trees & Vegetation</option>
                        <option value="parks">Parks & Recreation</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <!-- Search Filter -->
                <div class="filter-section">
                    <h6><i class="bi bi-search"></i> Search</h6>
                    <input type="text" class="form-control" id="search-filter" placeholder="Search by address or description...">
                </div>
                
                <!-- Map Controls -->
                <div class="filter-section">
                    <h6><i class="bi bi-map"></i> Map Tools</h6>
                    <button class="btn btn-primary btn-sm w-100 mb-2" onclick="resetMapView()">
                        <i class="bi bi-arrow-clockwise"></i> Reset View
                    </button>
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="fitAllMarkers()">
                        <i class="bi bi-bounding-box"></i> Fit All Markers
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Legend -->
            <div class="legend">
                <h6>Service Request Status</h6>
                <div class="legend-item">
                    <div class="legend-color" style="background: #27ae60;"></div>
                    <span class="legend-text">New Requests</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f39c12;"></div>
                    <span class="legend-text">In Progress</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span class="legend-text">Closed</span>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('Starting enhanced map without clustering...');
        
        // Global variables
        let map;
        let allMarkers = [];
        let filteredMarkers = [];
        let allRequests = [];
        
        // Status color mapping based on web map best practices
        const statusColors = {
            'New': '#27ae60',        // Green - new requests need attention
            'Open': '#27ae60',       // Green - treat as new
            'Inspect': '#f39c12',    // Orange - in progress
            'InProgress': '#f39c12', // Orange - in progress  
            'Closed': '#e74c3c',     // Red - completed
            'Complete': '#e74c3c',   // Red - completed
            'default': '#6c757d'     // Gray - unknown status
        };
        
        // Function to get status color
        function getStatusColor(status) {
            return statusColors[status] || statusColors.default;
        }
        
        // Function to create custom colored marker
        function createColoredMarker(color) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${color};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
        }
        
        // Function to reset map view
        function resetMapView() {
            map.setView([38.6270, -90.1994], 12);
        }
        
        // Function to fit all visible markers
        function fitAllMarkers() {
            if (filteredMarkers.length > 0) {
                const group = new L.featureGroup(filteredMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Function to update statistics
        function updateStats() {
            const statusCounts = {
                'New': 0,
                'Inspect': 0, 
                'Closed': 0,
                'Other': 0
            };
            
            filteredMarkers.forEach(marker => {
                const status = marker.requestData.status;
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                } else {
                    statusCounts['Other']++;
                }
            });
            
            document.getElementById('total-count').textContent = filteredMarkers.length;
            document.getElementById('new-count').textContent = statusCounts.New + statusCounts.Other;
            document.getElementById('closed-count').textContent = statusCounts.Closed;
        }
        
        // Function to categorize problem type based on description and department
        function getProblemCategory(request) {
            const description = (request.description || '').toLowerCase();
            const department = (request.submit_to || '').toLowerCase();
            
            // Trash and refuse
            if (description.includes('trash') || description.includes('refuse') || 
                description.includes('container') || description.includes('yard waste') ||
                department.includes('refuse')) {
                return 'refuse';
            }
            
            // Traffic and street lights
            if (description.includes('light') || description.includes('traffic') ||
                department.includes('traffic')) {
                return 'traffic';
            }
            
            // Street and infrastructure
            if (description.includes('street') || description.includes('pothole') || 
                description.includes('sidewalk') || description.includes('curb') ||
                department.includes('street')) {
                return 'street';
            }
            
            // Abandoned vehicles
            if (description.includes('vehicle') || description.includes('car') ||
                description.includes('abandoned') || description.includes('derelict')) {
                return 'vehicle';
            }
            
            // Building issues
            if (description.includes('building') || description.includes('exterior') ||
                department.includes('building')) {
                return 'building';
            }
            
            // Trees and vegetation
            if (description.includes('tree') || description.includes('weed') || 
                description.includes('grass') || description.includes('vegetation') ||
                department.includes('forestry')) {
                return 'forestry';
            }
            
            // Parks and recreation
            if (description.includes('park') || department.includes('parks')) {
                return 'parks';
            }
            
            return 'other';
        }
        
        // Function to apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('status-filter').value;
            const problemTypeFilter = document.getElementById('problem-type-filter').value;
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();
            
            // Clear existing filtered markers from map
            filteredMarkers.forEach(marker => map.removeLayer(marker));
            
            // Apply filters
            filteredMarkers = allMarkers.filter(marker => {
                const request = marker.requestData;
                
                // Status filter
                if (statusFilter && request.status !== statusFilter) {
                    return false;
                }
                
                // Problem type filter
                if (problemTypeFilter && getProblemCategory(request) !== problemTypeFilter) {
                    return false;
                }
                
                // Search filter
                if (searchFilter) {
                    const searchText = (
                        (request.description || '') + ' ' + 
                        (request.prob_address || '') + ' ' + 
                        (request.status || '')
                    ).toLowerCase();
                    
                    if (!searchText.includes(searchFilter)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Add filtered markers back to map
            filteredMarkers.forEach(marker => map.addLayer(marker));
            
            // Update statistics
            updateStats();
        }
        
        // Initialize map
        map = L.map('map').setView([38.6270, -90.1994], 12);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        console.log('Map initialized without clustering');
        
        // Load service requests
        fetch('/api/service-requests?per_page=1000')
            .then(response => {
                console.log('API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Got data:', data);
                const requests = data.service_requests || [];
                console.log('Number of requests:', requests.length);
                allRequests = requests;
                
                let markersAdded = 0;
                
                requests.forEach((request, index) => {
                    if (request.geometry && request.geometry.coordinates && Array.isArray(request.geometry.coordinates)) {
                        const [x, y] = request.geometry.coordinates;
                        
                        // Transform from EPSG:3857 to EPSG:4326
                        const lng = (x / 20037508.34) * 180;
                        const lat = (Math.atan(Math.exp(y * Math.PI / 20037508.34)) * 2 - Math.PI / 2) * 180 / Math.PI;
                        
                        // Check if coordinates are in St. Louis area
                        if (lng >= -91 && lng <= -89 && lat >= 38 && lat <= 39) {
                            // Get status and color
                            const status = request.status || 'Unknown';
                            const color = getStatusColor(status);
                            
                            // Create marker with appropriate color
                            const marker = L.marker([lat, lng], {
                                icon: createColoredMarker(color)
                            }).bindPopup(`
                                <div style="min-width: 280px;">
                                    <h6 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px;">${request.description || 'No description'}</h6>
                                    <div style="margin: 8px 0;"><strong>Status:</strong> <span style="color: ${color}; font-weight: bold; background: ${color}20; padding: 2px 8px; border-radius: 12px;">${status}</span></div>
                                    <div style="margin: 5px 0;"><strong>Category:</strong> <span style="background: #f8f9fa; padding: 2px 6px; border-radius: 8px; font-size: 12px; text-transform: capitalize;">${getProblemCategory(request).replace(/([A-Z])/g, ' $1').trim()}</span></div>
                                    <div style="margin: 5px 0;"><strong>Address:</strong> ${request.prob_address || 'N/A'}</div>
                                    <div style="margin: 5px 0;"><strong>Date:</strong> ${request.created_at ? new Date(request.created_at).toLocaleDateString() : 'N/A'}</div>
                                    <div style="margin: 5px 0;"><strong>Request ID:</strong> <code>${request.request_id || 'N/A'}</code></div>
                                    <div style="margin: 5px 0;"><strong>Department:</strong> ${(request.submit_to || '').replace(/,/g, ', ') || 'N/A'}</div>
                                </div>
                            `);
                            
                            // Store request data with marker for filtering
                            marker.requestData = request;
                            
                            allMarkers.push(marker);
                            markersAdded++;
                        }
                    }
                });
                
                console.log('Created', markersAdded, 'markers');
                
                // Initially show all markers
                filteredMarkers = [...allMarkers];
                filteredMarkers.forEach(marker => map.addLayer(marker));
                
                // Update statistics
                updateStats();
                
                if (markersAdded === 0) {
                    alert('No service requests found to display!');
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('total-count').textContent = 'Error';
                alert('Error loading service requests: ' + error.message);
            });
            
        // Add event listeners for filters
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('problem-type-filter').addEventListener('change', applyFilters);
        document.getElementById('search-filter').addEventListener('input', applyFilters);
    </script>
</body>
</html>
