<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Service Request - STL 311 Plus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .form-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #0d6efd;
        }
        .form-section h5 {
            color: #0d6efd;
            margin-bottom: 1rem;
        }
        #map {
            height: 300px;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .emergency-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #664d03;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .category-card {
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .category-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .category-card.selected {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .attachment-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 0.25rem;
        }
        .progress {
            height: 0.5rem;
            margin-bottom: 1rem;
        }
        .validation-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-city me-2"></i>STL 311 Plus
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-map me-1"></i>View Map
                </a>
                <a class="nav-link active" href="/submit">
                    <i class="fas fa-plus me-1"></i>Submit Request
                </a>
                <a class="nav-link" href="/track">
                    <i class="fas fa-search me-1"></i>Track Request
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Progress Indicator -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex justify-content-between text-muted small">
                    <span>Category</span>
                    <span>Location</span>
                    <span>Details</span>
                    <span>Contact</span>
                    <span>Review</span>
                </div>
            </div>
        </div>

        <!-- Emergency Alert -->
        <div id="emergencyAlert" class="emergency-alert d-none">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Emergency Situations</h6>
            <p class="mb-0">For life-threatening emergencies, call <strong>911</strong> immediately. For urgent city services after hours, call <strong>(314) 622-4800</strong>.</p>
        </div>

        <!-- Multi-step Form -->
        <form id="serviceRequestForm" enctype="multipart/form-data">
            <!-- Step 1: Category Selection -->
            <div class="form-step" id="step1">
                <div class="form-section">
                    <h5><i class="fas fa-list me-2"></i>Step 1: Select Service Category</h5>
                    <p class="text-muted">Choose the category that best describes your service request.</p>
                    
                    <div class="row" id="categorySelection">
                        <!-- Categories will be loaded dynamically -->
                    </div>
                    
                    <input type="hidden" id="selectedCategory" name="category" required>
                    <div class="invalid-feedback">Please select a service category.</div>
                </div>
            </div>

            <!-- Step 2: Location -->
            <div class="form-step d-none" id="step2">
                <div class="form-section">
                    <h5><i class="fas fa-map-marker-alt me-2"></i>Step 2: Location Information</h5>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <label for="address" class="form-label">Street Address *</label>
                            <input type="text" class="form-control" id="address" name="prob_address" required 
                                   placeholder="123 Main Street">
                            <div class="invalid-feedback">Please provide a street address.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="zipCode" class="form-label">ZIP Code</label>
                            <input type="text" class="form-control" id="zipCode" name="prob_zip" 
                                   pattern="[0-9]{5}" placeholder="63101">
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">Confirm Location on Map</label>
                            <div id="map"></div>
                            <small class="text-muted">Click on the map to pinpoint the exact location, or search for the address above.</small>
                        </div>
                    </div>
                    
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                </div>
            </div>

            <!-- Step 3: Request Details -->
            <div class="form-step d-none" id="step3">
                <div class="form-section">
                    <h5><i class="fas fa-edit me-2"></i>Step 3: Request Details</h5>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description *</label>
                        <textarea class="form-control" id="description" name="description" rows="4" required
                                  placeholder="Please provide a detailed description of the issue..."></textarea>
                        <div class="form-text">Be specific about what you're seeing and where exactly it's located.</div>
                        <div class="invalid-feedback">Please provide a description of the issue.</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="priority" class="form-label">Priority Level</label>
                            <select class="form-select" id="priority" name="priority">
                                <option value="low">Low - Can wait several days</option>
                                <option value="normal" selected>Normal - Standard response time</option>
                                <option value="high">High - Needs prompt attention</option>
                                <option value="urgent">Urgent - Safety concern</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="isEmergency" name="is_emergency">
                                <label class="form-check-label text-danger" for="isEmergency">
                                    <strong>This is an emergency situation</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label for="attachments" class="form-label">Photos/Documents (Optional)</label>
                        <input type="file" class="form-control" id="attachments" name="attachments" 
                               accept="image/*,.pdf,.doc,.docx" multiple>
                        <div class="form-text">You can upload up to 5 files (max 10MB each). Accepted formats: JPG, PNG, PDF, DOC</div>
                        <div id="attachmentPreview" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Contact Information -->
            <div class="form-step d-none" id="step4">
                <div class="form-section">
                    <h5><i class="fas fa-user me-2"></i>Step 4: Contact Information</h5>
                    <p class="text-muted">Provide your contact information to receive updates about your request.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="citizenName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="citizenName" name="citizen_name" 
                                   placeholder="John Doe">
                        </div>
                        <div class="col-md-6">
                            <label for="citizenEmail" class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="citizenEmail" name="citizen_email" required
                                   placeholder="john@example.com">
                            <div class="invalid-feedback">Please provide a valid email address.</div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="citizenPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="citizenPhone" name="citizen_phone" 
                                   placeholder="(314) 555-0123">
                        </div>
                        <div class="col-md-6">
                            <label for="contactMethod" class="form-label">Preferred Contact Method</label>
                            <select class="form-select" id="contactMethod" name="contact_method_preference">
                                <option value="email" selected>Email</option>
                                <option value="phone">Phone</option>
                                <option value="none">No contact needed</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Review & Submit -->
            <div class="form-step d-none" id="step5">
                <div class="form-section">
                    <h5><i class="fas fa-check me-2"></i>Step 5: Review Your Request</h5>
                    
                    <div id="requestSummary">
                        <!-- Summary will be populated dynamically -->
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmAccuracy" required>
                        <label class="form-check-label" for="confirmAccuracy">
                            I confirm that the information provided is accurate and complete.
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="agreeToTerms" required>
                        <label class="form-check-label" for="agreeToTerms">
                            I agree to the <a href="/terms" target="_blank">Terms of Service</a> and understand this system is for non-emergency requests only.
                        </label>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="row mt-4">
                <div class="col-6">
                    <button type="button" id="prevBtn" class="btn btn-outline-secondary d-none" onclick="changeStep(-1)">
                        <i class="fas fa-arrow-left me-2"></i>Previous
                    </button>
                </div>
                <div class="col-6 text-end">
                    <button type="button" id="nextBtn" class="btn btn-primary" onclick="changeStep(1)">
                        Next <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                    <button type="submit" id="submitBtn" class="btn btn-success d-none">
                        <i class="fas fa-paper-plane me-2"></i>Submit Request
                    </button>
                </div>
            </div>
        </form>

        <!-- Success Modal -->
        <div class="modal fade" id="successModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-check-circle me-2"></i>Request Submitted Successfully
                        </h5>
                    </div>
                    <div class="modal-body">
                        <p>Your service request has been submitted successfully!</p>
                        <p><strong>Request ID:</strong> <span id="requestId"></span></p>
                        <p>You will receive email updates about your request. You can also track its status using the request ID.</p>
                    </div>
                    <div class="modal-footer">
                        <a href="/" class="btn btn-primary">View All Requests</a>
                        <button type="button" class="btn btn-success" onclick="trackRequest()">Track This Request</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentStep = 1;
        let map, marker;
        let selectedCategoryData = null;
        
        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadCategories();
            setupFormValidation();
        });
        
        // Initialize Leaflet map
        function initializeMap() {
            map = L.map('map').setView([38.6270, -90.1994], 12); // St. Louis center
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            map.on('click', function(e) {
                placeMarker(e.latlng);
            });
        }
        
        // Place marker on map
        function placeMarker(latlng) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(latlng).addTo(map);
            document.getElementById('latitude').value = latlng.lat;
            document.getElementById('longitude').value = latlng.lng;
        }
        
        // Load service categories
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const categories = await response.json();
                
                const container = document.getElementById('categorySelection');
                container.innerHTML = '';
                
                categories.forEach(category => {
                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4 mb-3';
                    card.innerHTML = `
                        <div class="category-card card h-100" onclick="selectCategory('${category.name}', this)">
                            <div class="card-body">
                                <h6 class="card-title">${category.name}</h6>
                                <p class="card-text small text-muted">${category.description}</p>
                                <small class="text-primary">
                                    <i class="fas fa-clock me-1"></i>${category.estimated_response_time}
                                </small>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        // Select category
        function selectCategory(categoryName, element) {
            // Remove previous selections
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select this category
            element.classList.add('selected');
            document.getElementById('selectedCategory').value = categoryName;
            
            // Show/hide emergency alert based on category
            const emergencyEligible = ['Traffic & Signs', 'Trees & Forestry'].includes(categoryName);
            const alertElement = document.getElementById('emergencyAlert');
            if (emergencyEligible) {
                alertElement.classList.remove('d-none');
            } else {
                alertElement.classList.add('d-none');
            }
        }
        
        // Step navigation
        function changeStep(direction) {
            const totalSteps = 5;
            
            // Validate current step before proceeding
            if (direction > 0 && !validateStep(currentStep)) {
                return;
            }
            
            // Hide current step
            document.getElementById(`step${currentStep}`).classList.add('d-none');
            
            // Update step number
            currentStep += direction;
            
            // Show new step
            if (currentStep <= totalSteps) {
                document.getElementById(`step${currentStep}`).classList.remove('d-none');
            }
            
            // Update progress bar
            const progress = (currentStep - 1) / (totalSteps - 1) * 100;
            document.querySelector('.progress-bar').style.width = `${progress}%`;
            
            // Update navigation buttons
            updateNavigationButtons();
            
            // Special handling for certain steps
            if (currentStep === 2) {
                // Focus on address input and resize map
                setTimeout(() => {
                    document.getElementById('address').focus();
                    map.invalidateSize();
                }, 100);
            } else if (currentStep === 5) {
                updateRequestSummary();
            }
        }
        
        // Validate current step
        function validateStep(step) {
            switch (step) {
                case 1:
                    return document.getElementById('selectedCategory').value !== '';
                case 2:
                    return document.getElementById('address').value.trim() !== '';
                case 3:
                    return document.getElementById('description').value.trim() !== '';
                case 4:
                    return document.getElementById('citizenEmail').value.trim() !== '';
                default:
                    return true;
            }
        }
        
        // Update navigation buttons
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            prevBtn.classList.toggle('d-none', currentStep === 1);
            nextBtn.classList.toggle('d-none', currentStep === 5);
            submitBtn.classList.toggle('d-none', currentStep !== 5);
        }
        
        // Update request summary
        function updateRequestSummary() {
            const summary = document.getElementById('requestSummary');
            const formData = new FormData(document.getElementById('serviceRequestForm'));
            
            summary.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Request Summary</h6>
                        <table class="table table-sm">
                            <tr><th>Category:</th><td>${formData.get('category')}</td></tr>
                            <tr><th>Address:</th><td>${formData.get('prob_address')}</td></tr>
                            <tr><th>Description:</th><td>${formData.get('description')}</td></tr>
                            <tr><th>Priority:</th><td class="text-capitalize">${formData.get('priority')}</td></tr>
                            <tr><th>Contact:</th><td>${formData.get('citizen_email')}</td></tr>
                            <tr><th>Phone:</th><td>${formData.get('citizen_phone') || 'Not provided'}</td></tr>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Setup form validation
        function setupFormValidation() {
            const form = document.getElementById('serviceRequestForm');
            form.addEventListener('submit', handleSubmit);
            
            // Real-time validation
            form.addEventListener('input', function(e) {
                if (e.target.required) {
                    e.target.classList.toggle('is-invalid', !e.target.value.trim());
                    e.target.classList.toggle('is-valid', e.target.value.trim());
                }
            });
        }
        
        // Handle form submission
        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/submit-request', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('requestId').textContent = result.request_id;
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();
                } else {
                    alert('Error submitting request: ' + result.error);
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert('An error occurred while submitting your request. Please try again.');
            }
        }
        
        // Track request function
        function trackRequest() {
            const requestId = document.getElementById('requestId').textContent;
            window.location.href = `/track?id=${requestId}`;
        }
        
        // Address geocoding
        document.getElementById('address').addEventListener('blur', async function() {
            const address = this.value.trim();
            if (!address) return;
            
            try {
                // Simple geocoding using Nominatim
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(address + ', St. Louis, MO')}`
                );
                const results = await response.json();
                
                if (results.length > 0) {
                    const latlng = L.latLng(results[0].lat, results[0].lon);
                    map.setView(latlng, 16);
                    placeMarker(latlng);
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
        });
        
        // File upload preview
        document.getElementById('attachments').addEventListener('change', function(e) {
            const preview = document.getElementById('attachmentPreview');
            preview.innerHTML = '';
            
            Array.from(e.target.files).forEach(file => {
                const div = document.createElement('div');
                div.className = 'd-inline-block me-2 mb-2';
                div.innerHTML = `
                    <div class="border rounded p-2 text-center" style="width: 120px;">
                        ${file.type.startsWith('image/') ? 
                            `<img src="${URL.createObjectURL(file)}" class="attachment-preview">` :
                            `<i class="fas fa-file fa-2x text-muted"></i>`
                        }
                        <small class="d-block text-muted mt-1">${file.name}</small>
                    </div>
                `;
                preview.appendChild(div);
            });
        });
    </script>
</body>
</html>
