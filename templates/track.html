<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Service Request - STL 311 Plus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .status-badge {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
        .timeline {
            position: relative;
            padding: 1rem 0;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            padding-left: 3rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 14px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0d6efd;
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px #dee2e6;
        }
        .timeline-item.completed::before {
            background: #198754;
        }
        .request-map {
            height: 300px;
            border-radius: 0.5rem;
        }
        .info-card {
            background: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        .attachment-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 0.25rem;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-city me-2"></i>STL 311 Plus
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-map me-1"></i>View Map
                </a>
                <a class="nav-link" href="/submit">
                    <i class="fas fa-plus me-1"></i>Submit Request
                </a>
                <a class="nav-link active" href="/track">
                    <i class="fas fa-search me-1"></i>Track Request
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Search Form -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h2><i class="fas fa-search me-2"></i>Track Service Request</h2>
                <form id="trackingForm" class="d-flex">
                    <input type="text" class="form-control me-2" id="requestIdInput" 
                           placeholder="Enter Request ID or Email Address" required>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Request Details -->
        <div id="requestDetails" class="d-none">
            <div class="row">
                <!-- Main Request Information -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-clipboard-list me-2"></i>
                                Request Details
                            </h5>
                            <span id="statusBadge" class="badge status-badge">Loading...</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Request ID:</strong> <span id="displayRequestId"></span></p>
                                    <p><strong>Category:</strong> <span id="displayCategory"></span></p>
                                    <p><strong>Priority:</strong> <span id="displayPriority"></span></p>
                                    <p><strong>Submitted:</strong> <span id="displaySubmitted"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Address:</strong> <span id="displayAddress"></span></p>
                                    <p><strong>Assigned To:</strong> <span id="displayAssignedTo">Unassigned</span></p>
                                    <p><strong>Estimated Completion:</strong> <span id="displayEstimated">TBD</span></p>
                                    <p><strong>Last Updated:</strong> <span id="displayUpdated"></span></p>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Description</h6>
                                <p id="displayDescription" class="text-muted"></p>
                            </div>
                            
                            <!-- Citizen Updates -->
                            <div id="citizenUpdatesSection" class="mt-3 d-none">
                                <h6>Latest Updates</h6>
                                <div id="citizenUpdates" class="info-card"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Timeline -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                Status History
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="statusTimeline" class="timeline">
                                <!-- Timeline items will be populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Attachments -->
                    <div id="attachmentsSection" class="card mb-4 d-none">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-paperclip me-2"></i>
                                Attachments
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="attachmentsList" class="row"></div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Location Map -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                Location
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div id="requestMap" class="request-map"></div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-tools me-2"></i>
                                Actions
                            </h6>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="shareRequest()">
                                <i class="fas fa-share me-2"></i>Share Request
                            </button>
                            <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="exportToPDF()">
                                <i class="fas fa-download me-2"></i>Export to PDF
                            </button>
                            <button class="btn btn-outline-warning btn-sm w-100" onclick="reportIssue()">
                                <i class="fas fa-flag me-2"></i>Report Issue
                            </button>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-phone me-2"></i>
                                Need Help?
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="small mb-2">
                                <strong>City Services:</strong><br>
                                (314) 622-4800
                            </p>
                            <p class="small mb-2">
                                <strong>Online Support:</strong><br>
                                <a href="mailto:311@stlouis-mo.gov">311@stlouis-mo.gov</a>
                            </p>
                            <p class="small mb-0">
                                <strong>Emergency:</strong><br>
                                Call 911
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Not Found Message -->
        <div id="notFoundMessage" class="alert alert-warning d-none">
            <h5><i class="fas fa-exclamation-triangle me-2"></i>Request Not Found</h5>
            <p class="mb-0">We couldn't find a service request with that ID. Please check the ID and try again, or contact customer service for assistance.</p>
        </div>

        <!-- Email Lookup Results -->
        <div id="emailResults" class="d-none">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Your Service Requests
                    </h5>
                </div>
                <div class="card-body">
                    <div id="emailRequestsList">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Attachment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="img-fluid" alt="Attachment">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let requestMap;
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupEventListeners();
            checkUrlParameters();
        });
        
        function initializeMap() {
            requestMap = L.map('requestMap').setView([38.6270, -90.1994], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(requestMap);
        }
        
        function setupEventListeners() {
            document.getElementById('trackingForm').addEventListener('submit', handleTracking);
        }
        
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('id');
            if (requestId) {
                document.getElementById('requestIdInput').value = requestId;
                trackRequest(requestId);
            }
        }
        
        async function handleTracking(e) {
            e.preventDefault();
            const input = document.getElementById('requestIdInput').value.trim();
            
            if (!input) return;
            
            // Check if input looks like an email or request ID
            if (input.includes('@')) {
                await trackByEmail(input);
            } else {
                await trackRequest(input);
            }
        }
        
        async function trackRequest(requestId) {
            try {
                const response = await fetch(`/api/track-request/${requestId}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayRequestDetails(data);
                } else {
                    showNotFound();
                }
            } catch (error) {
                console.error('Tracking error:', error);
                showNotFound();
            }
        }
        
        async function trackByEmail(email) {
            try {
                const response = await fetch(`/api/track-by-email/${encodeURIComponent(email)}`);
                const data = await response.json();
                
                if (response.ok && data.length > 0) {
                    displayEmailResults(data);
                } else {
                    showNotFound();
                }
            } catch (error) {
                console.error('Email tracking error:', error);
                showNotFound();
            }
        }
        
        function displayRequestDetails(request) {
            // Hide other sections
            document.getElementById('notFoundMessage').classList.add('d-none');
            document.getElementById('emailResults').classList.add('d-none');
            
            // Show request details
            document.getElementById('requestDetails').classList.remove('d-none');
            
            // Populate basic information
            document.getElementById('displayRequestId').textContent = request.request_id;
            document.getElementById('displayCategory').textContent = request.category || 'General';
            document.getElementById('displayPriority').textContent = request.priority || 'Normal';
            document.getElementById('displayAddress').textContent = request.prob_address;
            document.getElementById('displayDescription').textContent = request.description;
            document.getElementById('displaySubmitted').textContent = formatDate(request.datetime_init);
            document.getElementById('displayUpdated').textContent = formatDate(request.updated_at);
            
            // Optional fields
            document.getElementById('displayAssignedTo').textContent = request.assigned_to || 'Unassigned';
            document.getElementById('displayEstimated').textContent = request.estimated_completion ? formatDate(request.estimated_completion) : 'TBD';
            
            // Status badge
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = request.status;
            statusBadge.className = `badge status-badge ${getStatusClass(request.status)}`;
            
            // Citizen updates
            if (request.citizen_updates) {
                document.getElementById('citizenUpdatesSection').classList.remove('d-none');
                document.getElementById('citizenUpdates').textContent = request.citizen_updates;
            }
            
            // Update map
            if (request.geometry && request.geometry.coordinates) {
                const [lng, lat] = request.geometry.coordinates;
                const latlng = L.latLng(lat, lng);
                requestMap.setView(latlng, 16);
                L.marker(latlng).addTo(requestMap);
            }
            
            // Display timeline
            displayStatusTimeline(request.status_updates || []);
            
            // Display attachments
            if (request.attachments && request.attachments.length > 0) {
                displayAttachments(request.attachments);
            }
        }
        
        function displayEmailResults(requests) {
            document.getElementById('requestDetails').classList.add('d-none');
            document.getElementById('notFoundMessage').classList.add('d-none');
            document.getElementById('emailResults').classList.remove('d-none');
            
            const container = document.getElementById('emailRequestsList');
            container.innerHTML = '';
            
            requests.forEach(request => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="card-title">Request #${request.request_id}</h6>
                                <p class="card-text small text-muted">${request.description.substring(0, 100)}...</p>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>${formatDate(request.datetime_init)} • 
                                    <i class="fas fa-map-marker-alt me-1"></i>${request.prob_address}
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge ${getStatusClass(request.status)} mb-2">${request.status}</span><br>
                                <button class="btn btn-outline-primary btn-sm" onclick="trackRequest('${request.request_id}')">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function displayStatusTimeline(updates) {
            const timeline = document.getElementById('statusTimeline');
            timeline.innerHTML = '';
            
            // Always show submission
            const submissionItem = document.createElement('div');
            submissionItem.className = 'timeline-item completed';
            submissionItem.innerHTML = `
                <div class="small text-muted">${formatDate(new Date())}</div>
                <h6 class="mb-1">Request Submitted</h6>
                <p class="text-muted mb-0">Your service request has been received and is being processed.</p>
            `;
            timeline.appendChild(submissionItem);
            
            // Add status updates
            updates.forEach((update, index) => {
                const item = document.createElement('div');
                item.className = `timeline-item ${index === updates.length - 1 ? 'completed' : ''}`;
                item.innerHTML = `
                    <div class="small text-muted">${formatDate(update.created_at)}</div>
                    <h6 class="mb-1">Status: ${update.new_status}</h6>
                    ${update.update_message ? `<p class="text-muted mb-0">${update.update_message}</p>` : ''}
                `;
                timeline.appendChild(item);
            });
        }
        
        function displayAttachments(attachments) {
            document.getElementById('attachmentsSection').classList.remove('d-none');
            const container = document.getElementById('attachmentsList');
            container.innerHTML = '';
            
            attachments.forEach(attachment => {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-3';
                
                if (attachment.mime_type && attachment.mime_type.startsWith('image/')) {
                    col.innerHTML = `
                        <img src="/api/attachment/${attachment.id}" 
                             class="attachment-thumbnail" 
                             alt="${attachment.original_filename}"
                             onclick="showImageModal('/api/attachment/${attachment.id}')">
                        <small class="d-block text-center mt-1">${attachment.original_filename}</small>
                    `;
                } else {
                    col.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-file fa-3x text-muted mb-2"></i>
                            <small class="d-block">${attachment.original_filename}</small>
                            <a href="/api/attachment/${attachment.id}" class="btn btn-outline-primary btn-sm mt-1">
                                Download
                            </a>
                        </div>
                    `;
                }
                
                container.appendChild(col);
            });
        }
        
        function showNotFound() {
            document.getElementById('requestDetails').classList.add('d-none');
            document.getElementById('emailResults').classList.add('d-none');
            document.getElementById('notFoundMessage').classList.remove('d-none');
        }
        
        function showImageModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }
        
        function getStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower === 'new' || statusLower === 'open') return 'bg-primary';
            if (statusLower === 'in progress' || statusLower === 'assigned') return 'bg-warning';
            if (statusLower === 'closed' || statusLower === 'resolved') return 'bg-success';
            if (statusLower === 'cancelled') return 'bg-secondary';
            return 'bg-info';
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function shareRequest() {
            const requestId = document.getElementById('displayRequestId').textContent;
            const shareUrl = `${window.location.origin}/track?id=${requestId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `Service Request #${requestId}`,
                    text: 'View this service request status',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl);
                alert('Share link copied to clipboard!');
            }
        }
        
        function exportToPDF() {
            const requestId = document.getElementById('displayRequestId').textContent;
            window.open(`/api/export-request/${requestId}`, '_blank');
        }
        
        function reportIssue() {
            const requestId = document.getElementById('displayRequestId').textContent;
            const message = prompt('Please describe the issue with this request:');
            if (message) {
                // Submit issue report
                fetch('/api/report-issue', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        request_id: requestId,
                        issue_description: message
                    })
                }).then(() => {
                    alert('Thank you for your feedback. We will investigate this issue.');
                });
            }
        }
    </script>
</body>
</html>
